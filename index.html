<script>
let tracks = [];
let isRecording = false;
let metronomeInterval = null;
let nextTrackId = 1;

// Create audio context safely
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioContext = AudioCtx ? new AudioCtx() : null;

function addTrack() {
  const track = {
    id: nextTrackId++,
    name: `Track ${tracks.length + 1}`,
    volume: 75,
    pan: 0,
    muted: false,
    solo: false
  };
  tracks.push(track);
  updateTrackDisplay();
}

function getTrackById(id) {
  return tracks.find(t => t.id === Number(id)) || null;
}

function toggleMute(id) {
  const t = getTrackById(id);
  if (!t) return;
  t.muted = !t.muted;
  updateTrackDisplay();
}

function toggleSolo(id) {
  const t = getTrackById(id);
  if (!t) return;
  t.solo = !t.solo;
  updateTrackDisplay();
}

function setTrackVolume(id, value) {
  const t = getTrackById(id);
  if (!t) return;
  const v = Math.max(0, Math.min(100, Number(value)));
  if (!Number.isFinite(v)) return;
  t.volume = v;
  // If you later route audio per track, apply gain here.
  updateTrackDisplay();
}

function updateTrackDisplay() {
  const trackContainer = document.getElementById('tracks');
  if (!trackContainer) {
    console.warn('Missing element: #tracks');
    return;
  }

  trackContainer.innerHTML = tracks.map(track => `
    <div class="track" data-track-id="${track.id}">
      <h4>${track.name}</h4>
      <button type="button" onclick="toggleMute(${track.id})">${track.muted ? 'ğŸ”‡' : 'ğŸ”Š'}</button>
      <button type="button" onclick="toggleSolo(${track.id})">${track.solo ? 'â­' : 'â—‹'}</button>
      <label>
        Vol:
        <input type="range" min="0" max="100" value="${track.volume}"
          oninput="setTrackVolume(${track.id}, this.value)">
      </label>
    </div>
  `).join('');
}

async function toggleMetronome() {
  const label = document.getElementById('metronome');
  if (!label) console.warn('Missing element: #metronome');

  if (!audioContext) {
    console.warn('Web Audio not supported in this browser.');
    return;
  }

  // Ensure audio can play (needs user gesture)
  if (audioContext.state === 'suspended') {
    try { await audioContext.resume(); } catch (e) { console.warn(e); }
  }

  if (metronomeInterval) {
    clearInterval(metronomeInterval);
    metronomeInterval = null;
    if (label) label.textContent = 'ğŸ”‡ Metronome: OFF';
  } else {
    const bpm = 120;
